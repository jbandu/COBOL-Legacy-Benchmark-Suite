# Source Code Reverse-Engineering Overview

This document captures the structure and behaviour of the Investment Portfolio Management System as implemented in this repository. It was produced by analysing the COBOL source programs, copybooks, database definitions, and JCL delivered with the benchmark.

## Execution Domains

### Online transaction layer (CICS)
- `INQONLN` is the primary CICS front-end program. It receives terminal maps, evaluates the requested function from the communication area, and delegates to child handlers (`INQPORT` for current positions and `INQHIST` for history) while enforcing a two-step security check via `SECMGR` and centralised error handling through `ERRHNDL`.【F:src/programs/online/INQONLN.cbl†L1-L119】【F:src/programs/online/SECMGR.cbl†L1-L120】【F:src/programs/online/ERRHNDL.cbl†L1-L108】
- Position inquiries (`INQPORT`) read VSAM data (`POSFILE`) using the `POSREC` structure and drive CICS map output, while history inquiries (`INQHIST`) open DB2 cursors through the shared cursor manager (`CURSMGR`) and connection services (`DB2ONLN`/`DB2RECV`).【F:src/programs/online/INQPORT.cbl†L1-L88】【F:src/programs/online/INQHIST.cbl†L1-L140】【F:src/programs/online/CURSMGR.cbl†L1-L76】【F:src/programs/online/DB2ONLN.cbl†L1-L80】【F:src/programs/online/DB2RECV.cbl†L1-L120】
- Supporting services include the security manager `SECMGR` (CICS/DB2 authorisation and audit), cursor lifecycle management (`CURSMGR`), and DB2 recovery orchestration (`DB2RECV`). These routines encapsulate error reporting to `ERRHNDL` and provide uniform response codes to the callers.【F:src/programs/online/SECMGR.cbl†L1-L134】【F:src/programs/online/CURSMGR.cbl†L1-L76】【F:src/programs/online/DB2RECV.cbl†L1-L120】

### Batch processing layer
- Control programs `BCHCTL00`, `PRCSEQ00`, and `RCVPRC00` coordinate day-end batch execution. They manage batch control VSAM datasets (`BCHCTL` and `PRCSEQ` copybooks), enforce prerequisites, and drive recovery strategies using shared error handling via `ERRPROC`.【F:src/programs/batch/BCHCTL00.cbl†L1-L84】【F:src/programs/batch/PRCSEQ00.cbl†L1-L92】【F:src/programs/batch/RCVPRC00.cbl†L1-L132】【F:src/programs/common/ERRPROC.cbl†L1-L72】
- `HISTLD00` loads transaction history records from VSAM into DB2, combining file and DB2 access while honouring commit thresholds and checkpoint integration (`CKPRST` copybook procedures).【F:src/programs/batch/HISTLD00.cbl†L1-L104】
- Reporting programs (`RPTPOS00`, `RPTAUD00`, `RPTSTA00`) format position summaries, audit trails, and status metrics using shared record layouts (`POSREC`, `TRNREC`) and a standard return-code framework (`RTNCODE`). Associated JCL (for example `RPTPOS.jcl`) shows production catalogue definitions and datasets required to run each job.【F:src/programs/batch/RPTPOS00.cbl†L1-L136】【F:src/jcl/batch/RPTPOS.jcl†L1-L13】
- Additional infrastructure programs (`RTNCDE00`, `CKPRST`, `RTNANA00`) offer return-code management, checkpoint services, and analysis reporting to keep batch execution observable and recoverable.【F:src/programs/batch/CKPRST.cbl†L1-L60】【F:src/programs/batch/RTNCDE00.cbl†L1-L112】【F:src/programs/batch/RTNANA00.cbl†L40-L92】

### Portfolio maintenance services
- CRUD activity against the portfolio master VSAM file is concentrated in the `PORTMSTR` service program. It receives a command via linkage, validates portfolio attributes (ID format, status codes), and performs VSAM I/O while logging audit information and standard errors through shared routines (`ERRPROC`, `AUDPROC`).【F:src/programs/portfolio/PORTMSTR.cbl†L1-L154】【F:src/programs/portfolio/PORTMSTR.cbl†L200-L248】
- Companion programs (`PORTADD`, `PORTUPDT`, `PORTDEL`, `PORTREAD`, `PORTTRAN`, `PORTVALD`, `PORTTEST`) provide specialised entry points and test harnesses that wrap or exercise the `PORTMSTR` logic. They rely on the same `PORTFLIO` copybook layout and the error/audit subroutines found in `src/programs/common`.【F:src/programs/portfolio/PORTADD.cbl†L1-L72】【F:src/programs/common/AUDPROC.cbl†L1-L84】

### Utilities and test harness
- Utility programs (`UTLVAL00`, `UTLMNT00`, `UTLMON00`) perform enterprise operations such as data validation across VSAM/DB2 files, file maintenance (archiving, VSAM reorg), and system health monitoring. Each utility uses console I/O, shared return-code handling, and tailored file suites as declared in the corresponding `FILE-CONTROL` sections.【F:src/programs/utility/UTLVAL00.cbl†L1-L88】【F:src/programs/utility/UTLMNT00.cbl†L1-L80】【F:src/programs/utility/UTLMON00.cbl†L1-L76】
- The test suite contains `TSTGEN00` (test data generator) and `TSTVAL00` (result validation). These programs generate and validate portfolio and transaction datasets using the same copybooks as production code, ensuring consistency between test artefacts and application records.【F:src/programs/test/TSTGEN00.cbl†L1-L88】【F:src/programs/test/TSTVAL00.cbl†L1-L96】

## Shared Infrastructure

- **Error management** – `ERRPROC` (batch/common) persists structured error details to a sequential log, while `ERRHNDL` (online) writes to the DB2 `ERRLOG` table and determines CICS recovery actions. Both operate on the `ERRHAND` copybook to keep message formats consistent.【F:src/programs/common/ERRPROC.cbl†L1-L84】【F:src/programs/online/ERRHNDL.cbl†L1-L108】【F:src/copybook/common/ERRHAND.cpy†L1-L48】
- **DB2 services** – `DB2CONN` provides reusable connect/disconnect/status functions for batch jobs with retry logic, and `DB2CMT` centralises commit, rollback, savepoint, and statistics tracking. In the online layer, `DB2ONLN`/`DB2RECV` offer CICS-friendly connection pooling and recovery orchestration.【F:src/programs/common/DB2CONN.cbl†L1-L96】【F:src/programs/common/DB2CMT.cbl†L1-L152】【F:src/programs/online/DB2ONLN.cbl†L1-L96】【F:src/programs/online/DB2RECV.cbl†L1-L120】
- **Return-code and checkpoint framework** – `RTNCDE00` standardises program return codes and severity levels, while `CKPRST` supplies checkpoint/restart entry points that batch programs can invoke through the `CKPRST` copybook. `RTNANA00` (Return Code Analysis) generates analytical reports from accumulated return-code metrics.【F:src/programs/batch/RTNCDE00.cbl†L1-L112】【F:src/programs/batch/CKPRST.cbl†L1-L60】【F:src/programs/batch/RTNANA00.cbl†L40-L92】
- **Security and audit** – The `SECMGR` program validates user credentials, verifies resource access against DB2 tables, and logs audit entries. `AUDPROC` writes before/after images to the audit log for portfolio operations, ensuring compliance traceability.【F:src/programs/online/SECMGR.cbl†L1-L134】【F:src/programs/common/AUDPROC.cbl†L1-L84】

## Data Stores and Copybooks

- **VSAM files** – Position master, transaction history, batch control, process sequence, and checkpoint datasets share standard layouts defined in `POSREC`, `HISTREC`, `BCHCTL`, `PRCSEQ`, and `CKPRST` copybooks. These layouts drive both batch and online processing to maintain data compatibility.【F:src/copybook/common/POSREC.cpy†L1-L32】【F:src/copybook/common/HISTREC.cpy†L1-L40】【F:src/copybook/batch/BCHCTL.cpy†L1-L60】【F:src/copybook/batch/PRCSEQ.cpy†L1-L56】【F:src/copybook/batch/CKPRST.cpy†L1-L64】
- **DB2 tables** – Database DDL includes `POSHIST` (portfolio transaction history), `ERRLOG` (online error log), `RTNCODES` (return-code dictionary), and the `PORTPLAN` plan definition, all grouped under the POSMVP database. The DDL highlights partitioning, indexes, and grant strategies, and aligns with the SQL accessed in batch/online programs.【F:src/database/db2/POSHIST.sql†L1-L56】【F:src/database/db2/ERRLOG.sql†L1-L56】【F:src/database/db2/RTNCODES.sql†L1-L48】【F:src/database/db2/PORTPLAN.sql†L1-L9】
- **Communication areas** – Online programs rely on `INQCOM` for passing request/response data between CICS transactions, while DB2 request metadata is standardised with `DB2REQ`. These copybooks ensure consistent field names across LINKed programs.【F:src/copybook/online/INQCOM.cpy†L1-L12】【F:src/copybook/online/DB2REQ.cpy†L1-L40】

## Program Inventory Snapshot

| Area | Program(s) | Key responsibilities |
| --- | --- | --- |
| Common services | `ERRPROC`, `AUDPROC`, `DB2CONN`, `DB2CMT`, `DB2ERR`, `DB2STAT` | Shared error/audit logging, DB2 connectivity, commit/statistics, and SQL error categorisation consumed by both batch and online flows.【F:src/programs/common/ERRPROC.cbl†L1-L84】【F:src/programs/common/AUDPROC.cbl†L1-L84】【F:src/programs/common/DB2CONN.cbl†L1-L112】【F:src/programs/common/DB2CMT.cbl†L1-L152】【F:src/programs/common/DB2ERR.cbl†L1-L76】【F:src/programs/common/DB2STAT.cbl†L1-L80】 |
| Batch control & recovery | `BCHCTL00`, `PRCSEQ00`, `RCVPRC00`, `CKPRST`, `RTNCDE00`, `RTNANA00` | Orchestrate batch job sequencing, recovery, checkpoints, and return-code lifecycle management across nightly processing.【F:src/programs/batch/BCHCTL00.cbl†L1-L84】【F:src/programs/batch/PRCSEQ00.cbl†L1-L92】【F:src/programs/batch/RCVPRC00.cbl†L1-L132】【F:src/programs/batch/CKPRST.cbl†L1-L60】【F:src/programs/batch/RTNCDE00.cbl†L1-L112】【F:src/programs/batch/RTNANA00.cbl†L40-L92】 |
| Batch business processing | `HISTLD00`, `RPTPOS00`, `RPTAUD00`, `RPTSTA00`, `POSUPDT`* | Load history, update positions, and build enterprise reports using shared copybooks; `POSUPDT` is delivered as a placeholder awaiting full implementation.*【F:src/programs/batch/HISTLD00.cbl†L1-L104】【F:src/programs/batch/RPTPOS00.cbl†L1-L152】【F:src/programs/batch/RPTAUD00.cbl†L1-L120】【F:src/programs/batch/RPTSTA00.cbl†L1-L96】【3f8591†L1-L2】 |
| Online transaction programs | `INQONLN`, `INQPORT`, `INQHIST`, `CURSMGR`, `DB2ONLN`, `DB2RECV`, `SECMGR`, `ERRHNDL` | CICS inquiry handling, cursor/connection management, security enforcement, and error recovery for interactive users.【F:src/programs/online/INQONLN.cbl†L1-L119】【F:src/programs/online/INQPORT.cbl†L1-L88】【F:src/programs/online/INQHIST.cbl†L1-L140】【F:src/programs/online/CURSMGR.cbl†L1-L76】【F:src/programs/online/DB2ONLN.cbl†L1-L96】【F:src/programs/online/DB2RECV.cbl†L1-L120】【F:src/programs/online/SECMGR.cbl†L1-L134】【F:src/programs/online/ERRHNDL.cbl†L1-L108】 |
| Portfolio services | `PORTMSTR`, `PORTADD`, `PORTUPDT`, `PORTDEL`, `PORTREAD`, `PORTTRAN`, `PORTVALD`, `PORTTEST` | VSAM-based portfolio CRUD, transaction posting, validation, and regression harness around the shared `PORTFLIO` structure and audit/error hooks.【F:src/programs/portfolio/PORTMSTR.cbl†L1-L154】【F:src/programs/portfolio/PORTADD.cbl†L1-L96】【F:src/programs/portfolio/PORTTRAN.cbl†L1-L112】【F:src/programs/portfolio/PORTVALD.cbl†L1-L104】【F:src/programs/portfolio/PORTTEST.cbl†L1-L120】 |
| Utilities & test | `UTLVAL00`, `UTLMNT00`, `UTLMON00`, `TSTGEN00`, `TSTVAL00` | Operational validation, file maintenance, monitoring, and automated test data/result processing built on top of production copybooks and return-code services.【F:src/programs/utility/UTLVAL00.cbl†L1-L88】【F:src/programs/utility/UTLMNT00.cbl†L1-L80】【F:src/programs/utility/UTLMON00.cbl†L1-L76】【F:src/programs/test/TSTGEN00.cbl†L1-L80】【F:src/programs/test/TSTVAL00.cbl†L1-L76】 |

*`POSUPDT` currently contains no compiled logic in this repository snapshot, signalling a stub for future position update functionality.【3f8591†L1-L2】

## JCL and Operations Linkage

Representative JCL members under `src/jcl` demonstrate how each COBOL module is scheduled. For instance, `RPTPOS.jcl` executes `RPTPOS00` using production datasets, while `UTLMON.jcl` and `UTLVAL.jcl` illustrate utility job wiring. These scripts form the bridge between the COBOL programs documented above and mainframe batch execution.【F:src/jcl/batch/RPTPOS.jcl†L1-L13】【F:src/jcl/utility/UTLMON.jcl†L1-L18】【F:src/jcl/utility/UTLVAL.jcl†L1-L18】

---

This overview should enable engineers to navigate the COBOL benchmark, identify where business logic lives, and trace dependencies between shared services, data definitions, and operational artefacts without reading each program in full.
